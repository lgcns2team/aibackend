<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS/STOMP ì—°ê²° í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #log { border: 1px solid #ddd; height: 280px; overflow: auto; padding: 8px; margin: 12px 0; white-space: pre-wrap; }
    input { padding: 8px; width: 70%; }
    button { padding: 8px 12px; }
    .row { margin: 6px 0; }
  </style>
</head>
<body>
  <h2>ì±„íŒ… ì—°ê²° í…ŒìŠ¤íŠ¸</h2>

  <div class="row">
    roomId: <input id="roomId" value="class-101" />
  </div>
  <div class="row">
    sender: <input id="sender" value="í•™ìƒ1" />
    <button id="connectBtn">ì—°ê²°</button>
    <button id="disconnectBtn" disabled>í•´ì œ</button>
  </div>

  <div id="log"></div>

  <div class="row">
    <input id="msg" placeholder="ë‚´ìš©ì„ ìž…ë ¥í•˜ì„¸ìš”..." />
    <button id="sendBtn" disabled>ì „ì†¡</button>
  </div>

  <!-- CDN: SockJS / STOMP -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

  <script>
    let client = null;

    const logEl = document.getElementById('log');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendBtn = document.getElementById('sendBtn');

    function log(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function now() {
      return new Date().toLocaleTimeString();
    }

    connectBtn.onclick = () => {
      const sender = document.getElementById('sender').value.trim();
      if (!sender) {
        alert("senderë¥¼ ìž…ë ¥í•˜ì„¸ìš”");
        return;
      }

      // same-origin: ë°±ì—”ë“œ(8081)ì—ì„œ ì—´ë¦° íŽ˜ì´ì§€ë©´ /ws-stompê°€ ë°±ì—”ë“œë¡œ ê°
      const socket = new SockJS('/api/ai/ws-stomp');

      client = new StompJs.Client({
        webSocketFactory: () => socket,
        debug: (str) => console.log(str),
        reconnectDelay: 0,

        onConnect: () => {
          log(`[${now()}] ì—°ê²° ì„±ê³µ (CONNECTED)`);

          // ì„œë²„ê°€ @SendTo("/topic/public")ë¡œ ë¿Œë¦¬ë¯€ë¡œ ì—¬ê¸° êµ¬ë…ì´ ì •ë‹µ
          client.subscribe('/topic/public', (frame) => {
            // ì„œë²„ DTO: { type: "CHAT|JOIN|LEAVE", sender: "...", content: "..." }
            const m = JSON.parse(frame.body);

            // í‘œì‹œìš© í¬ë§·
            if (m.type === 'JOIN') {
              log(`[${now()}] ${m.sender} ìž…ìž¥`);
            } else if (m.type === 'LEAVE') {
              log(`[${now()}] ${m.sender} í‡´ìž¥`);
            } else {
              log(`[${now()}] ${m.sender}: ${m.content ?? ''}`);
            }
          });

          // ìž…ìž¥ ë©”ì‹œì§€: ì»¨íŠ¸ë¡¤ëŸ¬ @MessageMapping("/chat.addUser") ë¡œ ë³´ë‚´ì•¼ í•¨
          // ì„œë²„ enumì— ë§žì¶° type="JOIN", ë‚´ìš© í•„ë“œëª…ì€ content
          client.publish({
            destination: '/app/chat.addUser',
            body: JSON.stringify({
              type: 'JOIN',
              sender: sender,
              content: '' // JOINì€ ë‚´ìš© ì—†ì–´ë„ ë¨
            })
          });

          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          sendBtn.disabled = false;
        },

        onStompError: (frame) => {
          log(`[${now()}] STOMP error: ` + frame.headers['message']);
          console.error(frame.body);
        },

        onWebSocketError: (evt) => {
          log(`[${now()}] WebSocket error (ì½˜ì†” í™•ì¸)`);
          console.error(evt);
        },

        onDisconnect: () => log(`[${now()}] ðŸ”Œ ì—°ê²° í•´ì œë¨`)
      });

      client.activate();
    };

    disconnectBtn.onclick = () => {
      if (client) client.deactivate();
      client = null;
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      sendBtn.disabled = true;
      log(`[${now()}] (ì‚¬ìš©ìž ìš”ì²­) ì—°ê²° ì¢…ë£Œ`);
    };

    sendBtn.onclick = () => {
      const sender = document.getElementById('sender').value.trim();
      const content = document.getElementById('msg').value.trim();
      if (!content || !client) return;

      // ì±„íŒ… ë©”ì‹œì§€: ì»¨íŠ¸ë¡¤ëŸ¬ @MessageMapping("/chat.sendMessage") ë¡œ ë³´ë‚´ì•¼ í•¨
      // ì„œë²„ enumì— ë§žì¶° type="CHAT", í•„ë“œëª…ì€ content
      client.publish({
        destination: '/app/chat.sendMessage',
        body: JSON.stringify({
          type: 'CHAT',
          sender: sender,
          content: content
        })
      });

      // ë‚´ í™”ë©´ì—ì„œë„ "ë³´ë‚¸ ê²ƒ" í‘œì‹œ(ì›í•˜ë©´ ì§€ì›Œë„ ë¨)
      log(`[${now()}] (me) ${sender}: ${content}`);

      document.getElementById('msg').value = '';
    };

    document.getElementById('msg').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendBtn.onclick();
    });
  </script>
</body>
</html>
